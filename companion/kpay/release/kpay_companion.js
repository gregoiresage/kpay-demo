/*
* KÂ·Pay Integration Library - v1.2.5 - Copyright Kiezel 2018
* Last Modified: 2018-06-07
*
* BECAUSE THE LIBRARY IS LICENSED FREE OF CHARGE, THERE IS NO 
* WARRANTY FOR THE LIBRARY, TO THE EXTENT PERMITTED BY APPLICABLE 
* LAW. EXCEPT WHEN OTHERWISE STATED IN WRITING THE COPYRIGHT 
* HOLDERS AND/OR OTHER PARTIES PROVIDE THE LIBRARY "AS IS" 
* WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESSED OR IMPLIED, 
* INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF 
* MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE. THE ENTIRE
* RISK AS TO THE QUALITY AND PERFORMANCE OF THE LIBRARY IS WITH YOU.
* SHOULD THE LIBRARY PROVE DEFECTIVE, YOU ASSUME THE COST OF ALL 
* NECESSARY SERVICING, REPAIR OR CORRECTION.
* 
* IN NO EVENT UNLESS REQUIRED BY APPLICABLE LAW OR AGREED TO IN 
* WRITING WILL ANY COPYRIGHT HOLDER, OR ANY OTHER PARTY WHO MAY 
* MODIFY AND/OR REDISTRIBUTE THE LIBRARY AS PERMITTED ABOVE, BE 
* LIABLE TO YOU FOR DAMAGES, INCLUDING ANY GENERAL, SPECIAL, 
* INCIDENTAL OR CONSEQUENTIAL DAMAGES ARISING OUT OF THE USE OR 
* INABILITY TO USE THE LIBRARY (INCLUDING BUT NOT LIMITED TO LOSS
* OF DATA OR DATA BEING RENDERED INACCURATE OR LOSSES SUSTAINED BY 
* YOU OR THIRD PARTIES OR A FAILURE OF THE LIBRARY TO OPERATE WITH
* ANY OTHER SOFTWARE), EVEN IF SUCH HOLDER OR OTHER PARTY HAS BEEN 
* ADVISED OF THE POSSIBILITY OF SUCH DAMAGES.
*/

/*****************************************************************************************/
/*                 GENERATED CODE BELOW THIS LINE - DO NOT MODIFY!                       */
/*****************************************************************************************/

//import { localStorage } from "local-storage"
var localStorageModule = require('local-storage').localStorage;    //because normal import currently doesn't work on Android
import { device } from "peer";
import * as messaging from 'messaging';
import { outbox } from "file-transfer";
import * as cbor from 'cbor';
import * as kcm from '../../../common/kpay/kpay_common.js';
var n="fb1.2.1",e=3e3,t=5e3,u=25e3,o=1e4,a=864e5,f=null,s=null,m=null,p=null,x=null,g=null,v="kpay_nextRecheckTimeLocalstorageKey",y="kpay__lastStatusResultLocalstorageKey",T="kpay_flagsLocalstorageKey",k="kpay_appIdLocalstorageKey",h="kpay_randLocalstorageKey",w="kpay_accountTokenLocalstorageKey",N=null,S=null,R=null,b=null,D=!1,I=!1,U=0,C=0,M=0,K=!1,_=!1,L=0,J=null,O=null,P=function(){},z=dn;export function initialize(){messaging.peerSocket.addEventListener("open",j),messaging.peerSocket.addEventListener("message",q),messaging.peerSocket.addEventListener("error",H),messaging.peerSocket.addEventListener("closed",Q),setTimeout(nn,6e4)}export function setEventHandler(n){P=n}export function setAccountTokenGenerator(n){z=n}export function startPurchase(){A(kcm.purchaseMessageFilename,{purchase:"start"})}export function cancelPurchase(){A(kcm.purchaseMessageFilename,{purchase:"cancel"})}function A(n,e,t,u){var o=function(){t&&t()},a=function(n){u&&u()};if((null==R||F())&&outbox.enqueue(n,cbor.encode(e)).then(o).catch(a),null==R||W())try{0===messaging.peerSocket.readyState?(messaging.peerSocket.send(e),o()):a("PeerSocket closed")}catch(n){a(n)}}function F(){return!W()}function W(){return 0==(64&R)}function j(){null!==gn()&&"licensed"!==gn().status&&pn()}function q(n){var e=n.data;if(kcm.isKPayMessage(e))if(B(e)){if(D&&N===e.appId&&S===e.random&&R===e.flags){var o=(new Date).getTime();if(K&&!_&&o-M<u)return;if(o-C<t)return}N=e.appId,S=e.random,R=e.flags,null!==gn()&&"unlicensed"!==gn().status&&pn(),V(),s&&(clearTimeout(s),s=null),s=setTimeout(Z,15e3)}else E(e)&&(D=!1,pn(),f&&(clearTimeout(f),f=null),s&&(clearTimeout(s),s=null),K&&sn())}function B(n){return kcm.isKPayMessage(n)&&0===n.type}function E(n){return kcm.isKPayMessage(n)&&3===n.type}function G(n){return{isKpayMsg:!0,type:1,serverResponse:n}}function H(n){}function Q(n){}function V(){D=!0;var t=(new Date).getTime(),u=z(),o=yn(),a="https://api.k-pay.io/api/v1/status?";a+="appid="+encodeURIComponent(N),a+="&rand="+encodeURIComponent(S),a+="&accounttoken="+encodeURIComponent(u),a+="&platform="+encodeURIComponent(o),a+="&flags="+encodeURIComponent(R),a+="&nocache="+encodeURIComponent(t),a+="&libv="+encodeURIComponent(n),U=t,fetch(a).then(function(n){return n.json()}).then(function(n){I=!1,C=(new Date).getTime(),n&&n.hasOwnProperty("status")&&X(n)}).catch(function(n){C=(new Date).getTime(),I||!D||null!==gn()&&"licensed"===gn().status||(f&&(clearTimeout(f),f=null),f=setTimeout(V,e)),I=!1})}function X(n){"unlicensed"===n.status&&(L=Number(n.paymentCode)),null!==gn()&&gn().status===n.status&&("unlicensed"!==gn().status||gn().purchaseStatus===n.purchaseStatus&&gn().paymentCode===n.paymentCode)||A(kcm.statusMessageFilename,G(n),function(){if("licensed"===n.status)Y(7,null,!1);else if("trial"===n.status){var e=Math.round((new Date).getTime()/1e3)+Number(n.trialDurationInSeconds),t=new Date;t.setTime(1e3*e),Y(3,t,!1)}else if("unlicensed"===n.status){var u=Number(n.paymentCode),o=null==gn()||u!==gn().paymentCode;"waitForUser"==n.purchaseStatus?Y(5,u,o):"inProgress"==n.purchaseStatus&&Y(6,u,o)}xn(n)},function(){}),"licensed"===n.status||"trial"===n.status?("licensed"===n.status?$(n):un(),D=!1,s&&(clearTimeout(s),s=null),sn()):(un(),_||K?_&&(f&&(clearTimeout(f),f=null),f=setTimeout(V,e)):on())}function Y(n,e,t){if(O!==n||t){O=n;try{P(n,e)}catch(n){}}}function Z(){var n=(new Date).getTime();D&&(K&&!_&&n-M>=u||(!K||_)&&n-C>=15e3)&&(null===gn()||"licensed"!==gn().status&&"trial"!==gn().status)&&(f&&(clearTimeout(f),f=null),f=setTimeout(V,0)),s&&(clearTimeout(s),s=null),s=setTimeout(Z,15e3)}function $(n){n&&"licensed"===n.status&&en(86400*n.validityPeriodInDays*1e3,!1)}function nn(){var n=Tn(v,null);null!==n&&en(n-(new Date).getTime(),!0)}function en(n,e){e||(kn(T,R),kn(k,N),kn(h,S)),n<0?ln():tn(n)}function tn(n){un();var e=new Date,t=n/1e3;e.setSeconds(e.getSeconds()+t),kn(v,e.getTime()),m&&(clearTimeout(m),m=null),m=setTimeout(ln,n)}function un(){m&&(clearTimeout(m),m=null),hn(v)}function ln(){R=Tn(T,R),N=Tn(k,N),S=Tn(h,S),tn(a),D||(I=!0,V())}function on(){if(!_&&!K&&null===J){var e=z(),t=yn(),o={type:"register",purchaseCode:L,data:{appid:N,accounttoken:e,platform:t,flags:R,random:S,libv:n}},a="wss://socket.kiezelpay.com";x&&(clearTimeout(x),x=null),x=setTimeout(function(){K||(_=!0,V(),an())},3e3);try{(J=new WebSocket(a)).onopen=function(n){K=!0,_=!1,rn(J,o)},J.onmessage=function(n){if(K){M=(new Date).getTime();var e=JSON.parse(n.data);if(e&&"registerReponse"==e.type&&e.keepAliveTimeout)u=e.keepAliveTimeout,p&&(clearTimeout(p),p=null),p=setTimeout(function(){cn(J)},u);else if(e&&"statusUpdate"==e.type){if(!e.data||!e.data.hasOwnProperty("status"))return;X(e.data)}}else try{J.close()}catch(n){}},J.onerror=function(n){K=!1,_=!0;try{J.close()}catch(n){}J=null,an(),V()},J.onclose=function(n){if(K){if(K=!1,null!==J)try{J.close()}catch(n){}J=null,_=!0,an(),V()}}}catch(n){}}}function cn(n){_||(rn(n,{type:"keepAlive"}),null!==p&&(clearTimeout(p),p=null),p=setTimeout(function(){cn(n)},u))}function an(){g&&(clearTimeout(g),g=null),g=setTimeout(function(){_=!1},o)}function rn(n,e){try{if(1===n.readyState){var t=JSON.stringify(e);n.send(t)}else fn()}catch(n){fn()}}function fn(){K=!1,_=!0;try{J.close()}catch(n){}J=null,an(),V()}function sn(){if(null!==p&&(clearTimeout(p),p=null),K=!1,null!==J)try{J.close()}catch(n){}J=null,D=!1}function mn(n){for(var e=[],i=0;i<n.length;i+=2)e.push(parseInt(n.substr(i,2),16));return e}function dn(){var n=localStorageModule.getItem(w);return null!==n&&void 0!==n&&"undefined"!==n||(n=vn(),kn(w,n)),n}function pn(){b=null,hn(y)}function xn(n){b=n,kn(y,JSON.stringify(b))}function gn(){if(null===b){var n=localStorageModule.getItem(y);null!==n&&void 0!==n&&"undefined"!==n&&(b=JSON.parse(n))}return b}function vn(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=16*Math.random()|0;return("x"==c?r:3&r|8).toString(16)})}function yn(){return device.modelName.toLowerCase()}function Tn(n,e){var t=localStorageModule.getItem(n);if(null!==t&&void 0!==t&&"undefined"!==t&&!isNaN(t)){var u=Number(t);if(!isNaN(u))return u}return e}function kn(n,e){null!==e&&void 0!==e&&localStorageModule.setItem(n,e.toString())}function hn(n){localStorageModule.removeItem(n)}